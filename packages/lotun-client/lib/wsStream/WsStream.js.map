{"version":3,"file":"WsStream.js","sourceRoot":"","sources":["../../src/wsStream/WsStream.ts"],"names":[],"mappings":"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","sourcesContent":["import { Duplex } from 'stream';\nimport EventEmitter from 'events';\nimport WebSocket from 'ws';\n\nexport const version = '1.0.0';\n\nexport type ClientError =\n  | 'CLIENT_INFO_INVALID'\n  | 'DEVICE_TOKEN_INVALID'\n  | 'DEVICE_TOKEN_UNPAIRED'\n  | 'INTERNAL_SERVER_ERROR'\n  | 'CONNECTION_ERROR';\n\nexport interface WsStreamDuplex extends Duplex {\n  ___destroyCalled: boolean;\n  ___cleanUpCalled: boolean;\n  ___endCalled: boolean;\n  ___finishCalled: boolean;\n  ___writePauseSent: boolean;\n  ___writePause: boolean;\n  ___writeResumeSent: boolean;\n\n  websocketStream: WebsocketStream | undefined;\n  streamId: string;\n  _cb: Function | undefined;\n}\n\nexport class DuplexStream extends Duplex implements WsStreamDuplex {\n  ___destroyCalled = false;\n  ___cleanUpCalled = false;\n  ___endCalled = false;\n  ___finishCalled = false;\n\n  ___writePauseSent = false;\n  ___writePause = false;\n  ___writeResumeSent = false;\n  websocketStream: WebsocketStream | undefined;\n  streamId: string;\n  _cb: Function | undefined;\n\n  constructor(options: any) {\n    super({\n      allowHalfOpen: false,\n    });\n\n    this.websocketStream = options.websocketStream;\n    this.streamId = options.streamId;\n\n    const duplexOnEnd = () => {\n      this.___endCalled = true;\n      if (this.___endCalled && this.___finishCalled) {\n        this._cleanUp();\n      }\n    };\n\n    const duplexOnFinish = () => {\n      this.___finishCalled = true;\n      if (this.___endCalled && this.___finishCalled) {\n        this._cleanUp();\n      }\n    };\n\n    this.on('end', duplexOnEnd);\n    this.on('finish', duplexOnFinish);\n    this.once('close', () => {\n      this.removeListener('end', duplexOnEnd);\n      this.removeListener('finish', duplexOnFinish);\n    });\n  }\n\n  destroy() {\n    if (!this.___destroyCalled) {\n      this.___destroyCalled = true;\n      if (!this.___endCalled) {\n        this.push(null);\n      }\n    }\n  }\n\n  _cleanUp() {\n    if (!this.___cleanUpCalled) {\n      this.___cleanUpCalled = true;\n      if (this.websocketStream) {\n        this.websocketStream._deleteStream(this.streamId);\n        this.websocketStream = undefined;\n      }\n      this.emit('close');\n    }\n  }\n\n  _writeResumed() {\n    this.___writePause = false;\n    if (this._canWrite() && this.websocketStream && this.websocketStream.ws) {\n      // @ts-ignore\n      const message = this.websocketStream.constructor.encodeMessage({\n        type: 'stream.writeResumed',\n        streamId: this.streamId,\n      });\n      this.websocketStream.ws.send(message);\n    }\n  }\n\n  _handleShouldPushMore(shouldPushMore: boolean) {\n    if (shouldPushMore === false && this.___writePauseSent === false) {\n      if (this._canWrite()) {\n        this.___writePauseSent = true;\n        // @ts-ignore\n        const message = this.websocketStream.constructor.encodeMessage({\n          type: 'stream.writePause',\n          streamId: this.streamId,\n        });\n        // @ts-ignore\n        this.websocketStream.ws.send(message);\n      }\n    }\n  }\n\n  _write(chunk: any, _: any, callback: Function) {\n    if (this._canWrite()) {\n      // @ts-ignore\n      const message = this.websocketStream.constructor.encodeMessage(\n        {\n          type: 'stream.write',\n          streamId: this.streamId,\n        },\n        chunk,\n      );\n      // @ts-ignore\n      this.websocketStream.ws.send(message);\n      if (this.___writePause) {\n        this._cb = callback;\n      } else {\n        callback();\n      }\n    } else {\n      callback();\n    }\n  }\n\n  _canWrite() {\n    const canWrite =\n      this.websocketStream &&\n      this.websocketStream.ws &&\n      this.websocketStream.ws.readyState === this.websocketStream.ws.OPEN;\n\n    return canWrite;\n  }\n\n  _read() {\n    if (this.___writePauseSent === true && this.___writeResumeSent === false) {\n      this.___writeResumeSent = true;\n      if (this._canWrite()) {\n        // @ts-ignore\n        const message = this.websocketStream.constructor.encodeMessage({\n          type: 'stream.writeResume',\n          streamId: this.streamId,\n        });\n        // @ts-ignore\n        this.websocketStream.ws.send(message);\n      }\n    }\n  }\n\n  _final(callback: Function) {\n    if (this._canWrite()) {\n      // @ts-ignore\n      const message = this.websocketStream.constructor.encodeMessage({\n        type: 'stream.final',\n        streamId: this.streamId,\n      });\n      // @ts-ignore\n      this.websocketStream.ws.send(message);\n    }\n    callback();\n  }\n\n  sendError(err: any) {\n    if (this._canWrite()) {\n      // @ts-ignore\n      const message = this.websocketStream.constructor.encodeMessage({\n        type: 'stream.error',\n        streamId: this.streamId,\n        data: {\n          code: err.code,\n          message: err.message,\n        },\n      });\n      // @ts-ignore\n      this.websocketStream.ws.send(message);\n    }\n  }\n}\n\nexport class WebsocketStream extends EventEmitter {\n  ws: WebSocket | undefined;\n  type: string;\n  lastStreamId: number;\n  streams: Map<any, any>;\n\n  wsOnError: (...args: any[]) => void;\n  wsOnClose: (...args: any[]) => void;\n  wsOnMessage: (...args: any[]) => void;\n\n  constructor(ws: WebSocket) {\n    super();\n    //@ts-ignore\n    if (ws._isServer) {\n      this.type = 'server';\n    } else {\n      this.type = 'client';\n    }\n\n    this.lastStreamId = 0;\n    this.ws = ws;\n    this.streams = new Map();\n\n    this.wsOnError = () => {\n      if (this.ws) {\n        this.ws.terminate();\n      }\n    };\n\n    this.wsOnClose = () => {\n      for (const value of this.streams.values()) {\n        value.destroy();\n      }\n\n      this.emit('close');\n\n      this.removeAllListeners();\n      if (this.ws) {\n        this.ws.removeListener('message', this.wsOnMessage);\n        this.ws.removeListener('close', this.wsOnClose);\n        this.ws.removeListener('error', this.wsOnMessage);\n        this.ws = undefined;\n      }\n    };\n\n    this.wsOnMessage = data => {\n      let message = null;\n      try {\n        // @ts-ignore\n        message = this.constructor.decodeMessage(data);\n\n        if (message.header.type === 'message') {\n          this.emit('message', message.header.data);\n        }\n\n        if (message.header.type === 'stream.create') {\n          const stream = this._createStream(message.header.streamId);\n\n          this.emit('stream', {\n            stream,\n            header: message.header.data,\n          });\n        }\n\n        if (message.header.type === 'stream.write') {\n          const stream = this._getStream(message.header.streamId);\n          if (stream) {\n            if (!stream.___endCalled) {\n              const shouldPushMore = stream.push(message.buffer);\n              stream._handleShouldPushMore(shouldPushMore);\n            }\n          }\n        }\n\n        if (message.header.type === 'stream.writePause') {\n          const stream = this._getStream(message.header.streamId);\n          if (stream) {\n            stream.___writePause = true;\n          }\n        }\n\n        if (message.header.type === 'stream.writeResumed') {\n          const stream = this._getStream(message.header.streamId);\n          if (stream) {\n            stream.___writePauseSent = false;\n            stream.___writeResumeSent = false;\n          }\n        }\n\n        if (message.header.type === 'stream.writeResume') {\n          const stream = this._getStream(message.header.streamId);\n          if (stream) {\n            stream._writeResumed();\n          }\n\n          if (stream && stream._cb) {\n            const cb = stream._cb;\n            stream._cb = null;\n\n            if (!stream.___finishCalled) {\n              cb();\n            }\n          }\n        }\n\n        if (message.header.type === 'stream.final') {\n          const stream = this._getStream(message.header.streamId);\n          if (stream) {\n            if (!stream.___endCalled) {\n              stream.push(null);\n            }\n          }\n        }\n\n        if (message.header.type === 'stream.error') {\n          const stream = this._getStream(message.header.streamId);\n          if (stream) {\n            const err = new Error(String(message.header.data.message));\n            // @ts-ignore\n            err.code = String(message.header.data.code);\n            stream.emit('error', err);\n          }\n        }\n      } catch (err) {\n        this.emit('decodeError', err);\n      }\n    };\n\n    this.ws.on('error', this.wsOnError);\n    this.ws.on('close', this.wsOnClose);\n    this.ws.on('message', this.wsOnMessage);\n  }\n\n  _getStream(streamId: string) {\n    return this.streams.get(streamId);\n  }\n\n  _deleteStream(streamId: string) {\n    this.streams.delete(streamId);\n  }\n\n  _createStream(streamId: string) {\n    const stream = new DuplexStream({\n      streamId,\n      websocketStream: this,\n    });\n\n    stream.pause();\n    this.streams.set(streamId, stream);\n    return stream;\n  }\n\n  _generateStreamId() {\n    this.lastStreamId++;\n    if (this.lastStreamId === Number.MAX_SAFE_INTEGER) {\n      this.lastStreamId = 0;\n    }\n    return `${this.type}/${this.lastStreamId}`;\n  }\n\n  createStream(data: any) {\n    const header = {\n      type: 'stream.create',\n      streamId: this._generateStreamId(),\n      data,\n    };\n\n    const stream = this._createStream(header.streamId);\n    // @ts-ignore\n    const message = this.constructor.encodeMessage(header);\n    // @ts-ignore\n    this.ws.send(message);\n    return stream;\n  }\n\n  send(data: any) {\n    // @ts-ignore\n    const message = this.constructor.encodeMessage({\n      type: 'message',\n      data,\n    });\n    // @ts-ignore\n    this.ws.send(message);\n  }\n\n  static decodeMessage(message: any) {\n    let index = 0;\n    while (message[index] > 47 && message[index] < 58) {\n      index++;\n      if (index > 9) {\n        throw Error('Bad payload');\n      }\n    }\n\n    const length = Number(message.slice(0, index).toString('utf8'));\n    const header = JSON.parse(message.slice(index, index + length).toString('utf8'));\n    const buffer = message.slice(index + length);\n\n    return {\n      header,\n      buffer,\n    };\n  }\n\n  static encodeMessage(headerObject: any, buffer = Buffer.from('')) {\n    const header = Buffer.from(JSON.stringify(headerObject));\n    const length = Buffer.from(String(header.length));\n    return Buffer.concat([length, header, buffer]);\n  }\n}\n"]}